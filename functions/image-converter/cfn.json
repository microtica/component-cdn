{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Transform": "AWS::Serverless-2016-10-31",
    "Description": "Image converter Lambda@Edge",
    "Parameters": {
        "ImageConverterLambdaBucket": {
            "Type": "String"
        },
        "ImageConverterLambdaBucketKey": {
            "Type": "String"
        },
        "Region": {
            "Type": "String"
        },
        "EnvId": {
            "Type": "String"
        },
        "ResourceId": {
            "Type": "String"
        },
        "RestrictAccess": {
            "Type": "String"
        }
    },
    "Resources": {
        "ImageConverterLambda": {
            "Type": "AWS::Serverless::Function",
            "DeletionPolicy": "Retain",
            "Properties": {
                "Handler": "dst/index.handler",
                "Runtime": "nodejs16.x",
                "Timeout": 30,
                "CodeUri": {
                    "Bucket": {
                        "Ref": "ImageConverterLambdaBucket"
                    },
                    "Key": {
                        "Ref": "ImageConverterLambdaBucketKey"
                    }
                },
                "AutoPublishAlias": "ImageConverter",
                "Policies": [
                    "AWSLambdaBasicExecutionRole",
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "secretsmanager:ListSecrets",
                                    "secretsmanager:GetSecretValue",
                                    "lambda:ListTags"
                                ],
                                "Resource": "*"
                            }
                        ]
                    }
                ],
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "edgelambda.amazonaws.com",
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Tags": {
                    "microtica:environment": {
                        "Ref": "EnvId"
                    },
                    "microtica:resource": {
                        "Ref": "ResourceId"
                    },
                    "microtica:region": {
                        "Ref": "Region"
                    },
                    "microtica:resource:restrict-access": {
                        "Ref": "RestrictAccess"
                    }
                }
            }
        },
        "ImageConverterLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:GetFunction",
                "FunctionName": {
                    "Ref": "ImageConverterLambda"
                },
                "Principal": "replicator.lambda.amazonaws.com"
            }
        }
    },
    "Outputs": {
        "Version": {
            "Value": {
                "Ref": "ImageConverterLambda.Version"
            }
        }
    }
}